<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  

  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="python的循环应用回收算法#标签（空格分隔）： python的循环应用回收算法 rc   “标记-清除”是为了解决循环引用的问题。可以包含其他对象引用的容器对象（比如：list，set，dict，class，instance）都可能产生循环引用。我们必须承认一个事实，如果两个对象的引用计数都为1，但是仅仅存在他们之间的循环引用，那么这两个对象都是需要被回收的，也就是说，它们的引用计数虽然表现为">
<meta property="og:type" content="article">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://yoursite.com/2019/01/08/python的循环应用回收算法/python的循环应用回收算法/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="python的循环应用回收算法#标签（空格分隔）： python的循环应用回收算法 rc   “标记-清除”是为了解决循环引用的问题。可以包含其他对象引用的容器对象（比如：list，set，dict，class，instance）都可能产生循环引用。我们必须承认一个事实，如果两个对象的引用计数都为1，但是仅仅存在他们之间的循环引用，那么这两个对象都是需要被回收的，也就是说，它们的引用计数虽然表现为">
<meta property="og:locale" content="default">
<meta property="og:updated_time" content="2019-01-08T15:38:07.472Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Hexo">
<meta name="twitter:description" content="python的循环应用回收算法#标签（空格分隔）： python的循环应用回收算法 rc   “标记-清除”是为了解决循环引用的问题。可以包含其他对象引用的容器对象（比如：list，set，dict，class，instance）都可能产生循环引用。我们必须承认一个事实，如果两个对象的引用计数都为1，但是仅仅存在他们之间的循环引用，那么这两个对象都是需要被回收的，也就是说，它们的引用计数虽然表现为">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>
</html>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-python的循环应用回收算法/python的循环应用回收算法" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/01/08/python的循环应用回收算法/python的循环应用回收算法/" class="article-date">
  <time datetime="2019-01-08T15:38:07.472Z" itemprop="datePublished">2019-01-08</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1><span id="python-de-xun-huan-ying-yong-hui-shou-suan-fa">python的循环应用回收算法</span><a href="#python-de-xun-huan-ying-yong-hui-shou-suan-fa" class="header-anchor">#</a></h1><p>标签（空格分隔）： python的循环应用回收算法 rc</p>
<hr>
<blockquote>
<p>“标记-清除”是为了解决循环引用的问题。可以包含其他对象引用的容器对象（比如：list，set，dict，class，instance）都可能产生循环引用。<br>我们必须承认一个事实，如果两个对象的引用计数都为1，但是仅仅存在他们之间的循环引用，那么这两个对象都是需要被回收的，也就是说，它们的引用计数虽然表现为非0，但实际上有效的引用计数为0。我们必须先将循环引用摘掉，那么这两个对象的有效计数就现身了。假设两个对象为A、B，我们从A出发，因为它有一个对B的引用，则将B的引用计数减1；然后顺着引用达到B，因为B有一个对A的引用，同样将A的引用减1，这样，就完成了循环引用对象间环摘除。<br>但是这样就有一个问题，假设对象A有一个对象引用C，而C没有引用A，如果将C计数引用减1，而最后A并没有被回收，显然，我们错误的将C的引用计数减1，这将导致在未来的某个时刻出现一个对C的悬空引用。这就要求我们必须在A没有被删除的情况下复原C的引用计数，如果采用这样的方案，那么维护引用计数的复杂度将成倍增加。</p>
<p>原理：“标记-清除”采用了更好的做法，我们并不改动真实的引用计数，而是将集合中对象的引用计数复制一份副本，改动该对象引用的副本。对于副本做任何的改动，都不会影响到对象生命走起的维护。<br>这个计数副本的唯一作用是寻找root object集合（该集合中的对象是不能被回收的）。当成功寻找到root object集合之后，首先将现在的内存链表一分为二，一条链表中维护root object集合，成为root链表，而另外一条链表中维护剩下的对象，成为unreachable链表。之所以要剖成两个链表，是基于这样的一种考虑：现在的unreachable可能存在被root链表中的对象，直接或间接引用的对象，这些对象是不能被回收的，一旦在标记的过程中，发现这样的对象，就将其从unreachable链表中移到root链表中；当完成标记后，unreachable链表中剩下的所有对象就是名副其实的垃圾对象了，接下来的垃圾回收只需限制在unreachable链表中即可。</p>
</blockquote>
<hr>
<ol>
<li>生成链表A</li>
<li>在容器对象创建的时候把容器对象添加到链表A中</li>
<li><p>在释放循环引用容器对象前，有些容器对象可能失去引用关系（count为0），但是在A链表中这个节点还是存在的，那么此时我们需要在A链表中剔除已经释放的容器对象</p>
</li>
<li><p>在分配对象时检测内存空间是否不足，如果不足需要检测A链表中是否存在循环引用容器对象</p>
</li>
<li>把对象的count复制到容器对象的count里，做一个备份<br> 在python里，普通对象和容器对象是两个结构体，换句话说，只有容器对象才需要复制count</li>
<li>通过遍历链表A把所有容器对象的备份count自减1，root对象除外<br> 因为对象的类型是不确定的，是否真的应该自减，比如root对象就不需要自减，比如用户有手动实现容器对象的话，那么也    会与我们的循环引用不兼容。这里python的做法是使用访问者模式，把自减的方法传递给具体容器对象，让具体实现去决定    是否应该执行自减。<strong>精髓</strong></li>
<li>因为链表的head是写死的，我们可以直接访问，其实这个head就是root，</li>
<li>我们直接访问链表的head，如果head是大于0，那么我们就认为这个链表里所有的对象都是可达的。如果root等于0，那么这    个链表的所有对象就是循环引用了，<br> <strong>对比传统的数据结构遍历，此方法的效率，要高的多。</strong></li>
<li>在不可达链表中移除带有终结器的对象。</li>
<li>把不可达链表的所有对象释放掉。<ol>
<li>释放的步骤如下<ol>
<li>自增</li>
<li>释放</li>
<li>自减<br>考虑到循环引用是多个对象相互引用，可能会因为释放操作造成自身清除，所以在count不为0的时候进行释放操作。</li>
</ol>
</li>
<li>对象可能会因为某种原因释放失败，需要把它重新放入到A链表中去。</li>
</ol>
</li>
</ol>
<p>#注：</p>
<ol>
<li><p>终结器，Object类的finalize方法叫做终结器，这种循环引用没办法解决，比如有两个对象，a和b，a的finalize方法访问b，b的finalize方法访问a，先释放哪个都不对。</p>
</li>
<li><p>分代<br> python的实现里是有分代的实现的，这篇文章面向新人，分代不是主线，简单为主。</p>
</li>
</ol>
<p>总结：</p>
<pre><code>1. 复制count，清空count，就是为了分离可达对象和不可达对象
2. python的count的类型使用了ssize_t的类型，该类型在32位环境下是int，在64位环境下是long
    该类型允许为负数，仅仅是为了debug方便。可以把count当做错误信息输出。
</code></pre><blockquote>
<p>官方文档</p>
<p><a href="https://docs.python.org/2/faq/design.html#how-does-python-manage-memory" target="_blank" rel="noopener">https://docs.python.org/2/faq/design.html#how-does-python-manage-memory</a></p>
<p><a href="http://arctrix.com/nas/python/gc/" target="_blank" rel="noopener">http://arctrix.com/nas/python/gc/</a></p>
<p><a href="https://github.com/python/cpython/blob/3.7/Doc/c-api/gcsupport.rst" target="_blank" rel="noopener">https://github.com/python/cpython/blob/3.7/Doc/c-api/gcsupport.rst</a></p>
<p>相关文档</p>
<p><a href="http://www.wklken.me/posts/2015/09/29/python-source-gc.html" target="_blank" rel="noopener">http://www.wklken.me/posts/2015/09/29/python-source-gc.html</a></p>
</blockquote>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/01/08/python的循环应用回收算法/python的循环应用回收算法/" data-id="cjqnxtosr000k0307n5w8m48o" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2019/01/08/rc/rc的环问题/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          (no title)
        
      </div>
    </a>
  
  
    <a href="/2019/01/08/python的循环应用回收算法/python的循环应用回收算法1/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title"></div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">January 2019</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2019/01/08/未分类/Prt 项目记录/">(no title)</a>
          </li>
        
          <li>
            <a href="/2019/01/08/未分类/java解释器分析/">(no title)</a>
          </li>
        
          <li>
            <a href="/2019/01/08/未分类/Tracing Gc/">(no title)</a>
          </li>
        
          <li>
            <a href="/2019/01/08/收藏/博客收藏/">(no title)</a>
          </li>
        
          <li>
            <a href="/2019/01/08/vcs/maple的repo/">(no title)</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2019 John Doe<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>